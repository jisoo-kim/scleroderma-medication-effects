---
title: '2020-03-05'
author: "Yizhen Xu"
date: "March 3, 2020"
output:
  html_document: default
  pdf_document: default
---

this is a test
again a test
third test

## Thoughts

In practice (G Computation)

 - Model Y|A
 
 - Insert A = a for Y(a)
 
 - Personalized medicine; in clinic, doctors insert medications to see projected future
 
 - Correct model specification for Y(a)
 
IPW-related methods also models treatment A 

 - Propensity score, PenComp
 
 - (Usually) goal: evaluate regime on population level
 
 - Create pseudo population by weighting individuals

We might not need to model treatment A, but need a sophisticated model for Y|A. Difficulties:

 - Effects of treatment combinations and treatment switching on the trajectories
 
 - Medication(s) might react fast on the dicease trajectories; ID 16 time 17, ID 3229 time 8.5

 - Dicease trajetory change over the same drug: dosage, drug resistance, side effect, adherence; ID 16
 
 - Unrecorded medications or non-medication procedures influence the trajectories; ID 1642 between time 22 and 27, ID 916 time 6
 
 - Input time of medication forms might not be aligned with when a medication was taken / comes into effect 

```{r, include=FALSE, warning=FALSE}
library(plyr)
library(tidyr)
library(ggplot2)
library(tidyr)
library(openxlsx)
library(gridExtra)
library(lubridate)
library(data.table)
library(VIM)
library(poLCA)
library(lme4)
library(splines)
library(MCMCglmm)
library(nnet)
filename = "C:\\Users\\Yizhen Xu\\Documents\\data and code\\Jisoo Data for Visualization 9-11-2018.xlsx"

visdat <- read.xlsx(filename, sheet = 1)
meds <- read.xlsx(filename, sheet = 3)

##### Functions ##### 

datf <- function(x){ x <- ifelse(x == 0, NA, x)
x <- as.Date(x, origin = "1899-12-30")
return(x)}

##### Medication data ##### 
meds$Meds.Date= datf(meds$Meds.Date)
setDT(meds)

### Plot medication

mv = c("Pred","MTX","MMF","CTX","IVIG","AZA","Rituximab","Tocilizumab","HCQ","TNF","LEF")
for(m in mv){
  meds[is.na(get(m)), (m) := 0]
}
med = meds[, c("Patient.ID","Meds.Date",mv), with=F]

# merge med and date of onset
tmp = visdat[, c("Patient.ID", "DateOnRP")]
setDT(tmp)
setkey(tmp, Patient.ID)
setkey(med, Patient.ID)
dat = merge(med, tmp, all.x=TRUE)
dat$DateOnRP = datf(dat$DateOnRP)
dat[, YTime := round(as.numeric(Meds.Date - DateOnRP)/365,2)]
dat[, c("Meds.Date","DateOnRP"):= NULL]
dat = dat[!is.na(YTime),] #11661 records from 1155 patients

```


## Medication Plot of 100 Patients

No treatment; MMF only; others only; MMF and others. 

```{r, echo=FALSE, warning=FALSE}
dat$nonMMF = apply(dat[,mv[-3],with=F],1,function(x) 1*(sum(x)!=0) )# 1 no trt (other than MMF)

dat[, type := 1]
dat[MMF == 1 & nonMMF == 0, type := 2] # 2 MMF only
dat[MMF == 1 & nonMMF == 1, type := 3] # 3 MMF and others
dat[MMF == 0 & nonMMF == 1 , type := 4] # 4 only others

nid = 100; pncol = 2 # nid number of patients, pncol columns of plots
idlist = sample(unique(dat$Patient.ID), nid)
pdall = dat[Patient.ID %in% idlist, ]
len =  pdall[,.N, by = Patient.ID]$N; pdall[,id:= rep(1:nid, len)]

m = matrix(c(1,2,3,3),nrow = 2,ncol = pncol,byrow = TRUE)
layout(mat = m,heights = c(0.9,0.1))
for( i in 1:pncol ){
  par(mai=c(0,0,0,0))
  nn =  floor(nid/pncol)-1
  ln = floor(nid/pncol)*(i-1)+1
  rg = ln:(ln+nn)
  pd = pdall[id %in% rg, ]
  plot(pd$YTime, pd$id, xlab="", ylab="",  yaxt='n',
       main="", col = pd$type, pch = 19)
}
#par(mai=c(0,0,0,0))
par(mar=c(0,0,1.1,0))
plot.new()
cl = sort(unique(pdall$type))
legend(x = "top",inset = 0, c("no trt","MMF","MMF and others","others"),
       text.col=cl,pch=19,col= cl,horiz=TRUE, bty="n", cex = 1.2)

```



No treatment; Pred only; MMF only; others only; MMF and others (include Pred). 

```{r, echo=FALSE, warning=FALSE}
pdall$nonMMF = apply(pdall[,mv[-3],with=F],1,function(x) 1*(sum(x)!=0) )# 1 no trt (other than MMF)
pdall$nonPred = apply(pdall[,mv[-1],with=F],1,function(x) 1*(sum(x)!=0) )
pdall[, type := 1]
pdall[MMF == 1 & nonMMF == 0, type := 2] # 2 MMF only
pdall[MMF == 1 & nonMMF == 1, type := 3] # 3 MMF and others
pdall[Pred == 1 & nonPred == 0, type := 5] # 5 Pred only
pdall[MMF == 0 & Pred == 0 & nonPred+nonMMF >= 1 , type := 4] # 4 only others (non Pred or MMF)

m = matrix(c(1,2,3,3),nrow = 2,ncol = pncol,byrow = TRUE)
layout(mat = m,heights = c(0.9,0.15))
for( i in 1:pncol ){
  par(mai=c(0,0,0,0))
  nn =  floor(nid/pncol)-1
  ln = floor(nid/pncol)*(i-1)+1
  rg = ln:(ln+nn)
  pd = pdall[id %in% rg, ]
  plot(pd$YTime, pd$id, xlab="", ylab="",  yaxt='n',
       main="", col = pd$type, pch = 19)
}
#par(mai=c(0,0,0,0))
par(mar=c(0,0,1.3,0))
plot.new()
cl = sort(unique(pdall$type))
legend(x = "top",inset = 0, c("no trt","MMF","MMF and others","others (not Pred or MMF)","Pred only"),
       text.col=cl,pch=19,col= cl,horiz=TRUE, bty="n", cex = 0.85)

```

## Combination Matrix

Diagonal boxes include frequencies from combinations 

```{r, echo=FALSE, warning=FALSE,message=FALSE}
pd = dat[, mv,with=F]

mvs = c("Pred","MTX","MMF","CTX","IVIG","AZA","RTX","TCZ","HCQ","TNF","LEF")

library(ggplot2)
library(hrbrthemes)
lcm = expand.grid(X = mvs, Y = mvs); lcm$ct = NA
k = 1
for( i in 1:length(mvs)){
  for(j in 1:length(mvs)){
    if(i==j){
      lcm[k,3] = sum(pd[,i,with=F]==1)
    } else {
      tmp = apply(pd[,c(i,j),with=F],1,sum)
      lcm[k,3] = sum(tmp == 2)
    }
    k = k+1
  }
}

# Give extreme colors:
#extrafont::loadfonts()
ggplot(lcm, aes(X, Y, fill= ct)) + 
  geom_tile() +
  scale_fill_gradient(low="white", high="blue") +
  theme_ipsum()

```

Diagonal boxes reflects the frequencies of only one medication is used 

```{r, echo=FALSE, warning=FALSE,message=FALSE}
cm = expand.grid(X = mvs, Y = mvs); lcm$ct = NA
k = 1
for( i in 1:length(mvs)){
  for(j in 1:length(mvs)){
    if(i==j){
      tmp = apply(pd[,-i,with=F],1,sum)
      lcm[k,3] = sum(pd[,i,with=F]==1 & tmp==0)
    } else {
      tmp = apply(pd[,c(i,j),with=F],1,sum)
      lcm[k,3] = sum(tmp == 2)
    }
    k = k+1
  }
}

# Give extreme colors:
#extrafont::loadfonts()
ggplot(lcm, aes(X, Y, fill= ct)) + 
  geom_tile() +
  scale_fill_gradient(low="white", high="blue") +
  theme_ipsum()
```

## Transition among States

No treatment; MMF only; others only; MMF and others. 

```{r, echo=FALSE, warning=FALSE}
dat$nonMMF = apply(dat[,mv[-3],with=F],1,function(x) 1*(sum(x)!=0) )# 1 no trt (other than MMF)

dat[, type := 1] # no trt
dat[MMF == 1 & nonMMF == 0, type := 2] # 2 MMF only
dat[MMF == 1 & nonMMF == 1, type := 3] # 3 MMF and others
dat[MMF == 0 & nonMMF == 1 , type := 4] # 4 only others

dat[, prevtype := c(NA, type[-.N]), by = Patient.ID]
tmp = dat[!is.na(prevtype), c("prevtype", "type"),with=F]

summ = tmp[, .N, by = c("prevtype", "type")]
summ = summ[order(prevtype,type)]
tm = matrix(summ$N, ncol = 4, byrow = T)
for(i in 1:nrow(tm)){
  tm[i,] = tm[i,]/sum(tm[i,])
}
colnames(tm) = rownames(tm) = c("no trt","MMF","include MMF","others")
round(tm,2)
```


No treatment; Pred only; MMF only; others only; MMF and others (can include Pred). 
```{r, echo=FALSE, warning=FALSE}

dat$nonMMF = apply(dat[,mv[-3],with=F],1,function(x) 1*(sum(x)!=0) )# 1 no trt (other than MMF)
dat$nonPred = apply(dat[,mv[-1],with=F],1,function(x) 1*(sum(x)!=0) )
dat[, type := 1]
dat[MMF == 1 & nonMMF == 0, type := 2] # 2 MMF only
dat[MMF == 1 & nonMMF == 1, type := 3] # 3 MMF and others
dat[Pred == 1 & nonPred == 0, type := 4] # 4 Pred only
dat[MMF == 0 & Pred == 0 & nonPred+nonMMF >= 1 , type := 5] # 5 only others (non Pred or MMF)

dat[, prevtype := c(NA, type[-.N]), by = Patient.ID]
tmp = dat[!is.na(prevtype), c("prevtype", "type"),with=F]

summ = tmp[, .N, by = c("prevtype", "type")]
summ = summ[order(prevtype,type)]
tm = matrix(summ$N, ncol = 5, byrow = T)
for(i in 1:nrow(tm)){
  tm[i,] = tm[i,]/sum(tm[i,])
}
colnames(tm) = rownames(tm) = c("no trt","MMF","include MMF","Pred","others")
round(tm,2)
```

## Multinomial Probit BART for Med Prediction

Use MBPART for Med predictions. Outcome of four categories, covariates include time since onset, gender, age, race, ethnicity, and the most recent measurements of mRSS, pFVC, EF. 

Current medication before or after prescription? Assuming it is after a current prescription.

Explain latent variables or utilities -- how is it different from HMM?

 - HMM: hidden (latent) states describes transition over time, the observation at time t is only probabilitically dependent on the current hidden state 
 
 - Multinomial probit: latent variables (utilities for each state) follow a mulvariate Gaussian distribution, the multinomial obseration is determined by the relative magnitude of the latent variables

```{r, eval=FALSE, echo=FALSE}
library(plyr)
library(tidyr)
library(ggplot2)
library(tidyr)
library(openxlsx)
library(gridExtra)
library(lubridate)
library(data.table)
library(VIM)
library(poLCA)
library(lme4)
library(splines)
library(MCMCglmm)
library(nnet)
library(GcompBART)

filename = "C:\\Users\\Yizhen Xu\\Documents\\data and code\\Jisoo Data for Visualization 9-11-2018.xlsx"

visdat <- read.xlsx(filename, sheet = 1)
meds <- read.xlsx(filename, sheet = 3)
mrss <- read.xlsx(filename, sheet = 4)
echo <- read.xlsx(filename, sheet = 11)
pft <- read.xlsx(filename, sheet = 14)

##### Functions ##### 

datf <- function(x){ x <- ifelse(x == 0, NA, x)
x <- as.Date(x, origin = "1899-12-30")
return(x)}

##### Medication data ##### 
meds$Meds.Date= datf(meds$Meds.Date)
setDT(meds)

mv = c("Pred","MTX","MMF","CTX","IVIG","AZA","Rituximab","Tocilizumab","HCQ","TNF","LEF")
for(m in mv){
  meds[is.na(get(m)), (m) := 0]
}
med = meds[, c("Patient.ID","Meds.Date",mv), with=F]

med$nonMMF = apply(med[,mv[-3],with=F],1,function(x) 1*(sum(x)!=0) )# 1 no trt (other than MMF)

med[, type := 1] # no trt
med[MMF == 1 & nonMMF == 0, type := 2] # 2 MMF only
med[MMF == 1 & nonMMF == 1, type := 3] # 3 MMF and others
med[MMF == 0 & nonMMF == 1 , type := 4] # 4 only others

med = med[, c("Patient.ID", "Meds.Date", "type"), with=F]

# longitudinal data for lung and heart
colnames(pft)[2] = "pftDate";pft$pftDate = datf(pft$pftDate)
pft$Pt.ID = as.numeric(pft$Pt.ID)
setDT(pft)

# merge med and lung data
# 1201 unique med patients, 1051 unique pft patients
length(unique(med$Patient.ID)); length(unique(pft$Pt.ID))
# 2068 perfect merge, 9794 with only med, 6008 with only pft
med[, tmpid := paste0(Patient.ID, "_", Meds.Date)]
pft[, tmpid := paste0(Pt.ID, "_", pftDate)]

setkey(med, tmpid)
setkey(pft, tmpid)
lung.med = merge(med, pft, all = TRUE)

lung.med$Date = lung.med$pftDate
lung.med[is.na(pftDate), Date := Meds.Date]
lung.med[is.na(Patient.ID), Patient.ID := Pt.ID]
lung.med = lung.med[order(Patient.ID, Date),]

lung.med[, c("Pt.ID") := NULL]

# merge (med, lung) and heart data
setDT(echo)
colnames(echo)[1] = "Pt.ID"
echo$echoDate = datf(echo$Date.of.ECHO); echo[, "Date.of.ECHO":=NULL]
echo[, tmpid := paste0(Pt.ID, "_", echoDate)]

setkey(lung.med, tmpid)
setkey(echo, tmpid)
heart.med = merge(lung.med, echo, all=TRUE)

heart.med[is.na(Date), Date := echoDate]
heart.med[is.na(Patient.ID), Patient.ID := Pt.ID]
str(heart.med)

heart.med[, c("Pt.ID") := NULL]

# merge (med, lung, heart) and skin data
setDT(mrss)
colnames(mrss)[1] = "Pt.ID"
colnames(mrss)[2] = "skinDate"
mrss$skinDate = datf(mrss$skinDate)
str(mrss)

mrss[, tmpid := paste0(Pt.ID, "_", skinDate)]

setkey(heart.med, tmpid)
setkey(mrss, tmpid)
skin.med = merge(heart.med, mrss, all=TRUE)

skin.med[is.na(Date), Date := skinDate]
skin.med[is.na(Patient.ID), Patient.ID := Pt.ID]

skin.med[, c("Pt.ID") := NULL]

str(skin.med)
#check
#sum(is.na(heart.med$Patient.ID))
#sum(is.na(heart.med$Date))

# merge (med, lung, heart, skin) and date of onset
tmp = visdat[, c("Patient.ID", "DateOnRP", "DOB","Sex","ethnic","Race1")]
setDT(tmp)
setkey(tmp, Patient.ID)
setkey(skin.med, Patient.ID)
dat = merge(skin.med, tmp, all.x=TRUE)
dat$DateOnRP = datf(dat$DateOnRP)
dat[, YTime := round(as.numeric(Date - DateOnRP)/365,2)]
dat$DOB = datf(dat$DOB)
dat$age1 = round(as.numeric(dat$Date - dat$DOB)/365) # range 16.39 to 95.64, mean 54.33

save(dat, file = "dat.RData")

d = dat[, c("Patient.ID", "Date", "YTime", "type", "age1", "Sex", "ethnic", "Race1", "Height", "Weight", "stppFVC", "stppDLCO", "RVSP", "Ejection.Fraction", "Total.Skin.Score" ), with=F]
colnames(d) =  c("Patient.ID", "Date", "YTime", "type", "age", "Sex", "ethnic", "Race", "Height", "Weight", "FVC", "DLCO", "RVSP", "EF", "mRSS" )

# carry forward (and backward for height and weight)
library(zoo)
for(var in c("Height", "Weight", "FVC", "DLCO", "RVSP", "EF", "mRSS")){
  d[, (paste0(var,"_M")) := 1*(is.na(get(var)))]
  d[, var1 := na.locf(get(var),na.rm = F), by = Patient.ID]
  if(var %in% c("Height", "Weight")){
    d[, var1 := na.locf(get(var),na.rm = F, fromLast = TRUE), by = Patient.ID]
  }
  d[is.na(get(var)), (var) := var1]
  d[is.na(get(var)), (var) := -99] # missing after carrying f/b coded as -99
}
d[, var1 :=NULL]

# previous outcome
d[, pretype := c(NA, type[-.N]), by=Patient.ID]
d[is.na(pretype), pretype := 0]
tmp = class.ind(d[, pretype]); colnames(tmp) = paste0("pretype_", colnames(tmp))
d = cbind(d, tmp[,-1]); d[,pretype :=NULL]

# create indicators
# Race
d[is.na(Race), Race := 9]; d[Race == 9, Race := 0]
tmp = class.ind(d[, Race]); colnames(tmp) = paste0("Race_",colnames(tmp))
d = cbind(d, tmp[, -ncol(tmp)]); d[, Race := NULL]
# ethnic
d[is.na(ethnic), ethnic := 9]
d[, ethnic_0 := 1*(ethnic == 0)]; d[, ethnic_1 := 1*(ethnic == 1)]; d[, ethnic := NULL] 
# Sex
d$Sex = as.numeric(d$Sex)

# keep those with non-negative time since onset (with onset date info non-missing)
d = d[!is.na(YTime) & YTime >= 0,]
# keep only medication records and delete 1 person with no gender info
d = d[!is.na(type) & !is.na(Sex),]

save(d, file = "d.RData")

# MPBART Alg3
KD = F; nuC = 1; Vm = diag(3); by = "1"; da = FALSE
nd = 3000; nb = 5000; nt = 100; p=length(unique(d$type)) # number of outcome levels
seed = 1

nsub = nrow(d); ntr = round(nsub*0.7)
set.seed(seed)
samp = sample(1:nsub, nsub, replace = F)

trid = samp[1:ntr]; trid = sort(trid)
trd = copy(d[trid,])

teid = samp[(ntr+1):nsub]; teid = sort(teid)
ted = copy(d[teid,])

RHS = colnames(d)[c(3,5:32)]
fml = paste0("type ~ ",paste(RHS,collapse = " + "))

source("BartGcomp_19-11-22_Functions.R")
mod = model_bart(as.formula(fml), data = trd, type = "multinomial",
                         base = by,
                         Prior = Prior_mult(p = p, nu_C = nuC, Vmat = Vm, ntree = nt),
                         Mcmc = Mcmc_mult(p = p,nb = nb, nd = nd),
                         correction = FALSE, Kindo = KD, do_alpha2_prior = da)
save(mod, file = "mod.RData")

ted = ted[, c("type",RHS), with=F]; trd = trd[, c("type",RHS),with=F]
acc = accuracyfun(bmpfit = mod,testd = ted,trdy = trd$type,tedy = ted$type)

save(acc, file = "acc.RData")

acc

BTr = mod$samp_y # train prediction
BTe = predict_bart(obj = mod, newdata = ted)$samp_y # test prediction
PmodeTr = apply(BTr, 1, ymode)
PmodeTe = apply(BTe, 1, ymode)

trd = copy(d[trid,]); ted = copy(d[teid,])
trd = trd[, c("Patient.ID", "YTime", "type"), with=F]
ted = ted[, c("Patient.ID", "YTime", "type"), with=F]
trd$pred = as.numeric(PmodeTr)
ted$pred = as.numeric(PmodeTe)

pd = rbind(trd, ted); pd = pd[order(Patient.ID, YTime)]
save(pd, file = "pd.RData")
```


```{r, echo=FALSE}
load("pd.RData")

nid = 50
set.seed(342020)
idlist = sample(unique(dat$Patient.ID), nid)
pd = pd[Patient.ID %in% idlist, ]
len =  pd[,.N, by = Patient.ID]$N; pd[,id:= rep(1:nid, len)]

m = matrix(c(1,2,3,3),nrow = 2,ncol = pncol,byrow = TRUE)
layout(mat = m,heights = c(0.9,0.1))
par(mai=c(0,0,0,0))
plot(pd$YTime, pd$id, xlab="", ylab="",  yaxt='n',
       main="", col = pd$type, pch = 19)
par(mai=c(0,0,0,0))
plot(pd$YTime, pd$id, xlab="", ylab="",  yaxt='n',
       main="", col = pd$pred, pch = 19)
#par(mai=c(0,0,0,0))
par(mar=c(0,0,1.1,0))
plot.new()
cl = sort(unique(pd$type))
legend(x = "top",inset = 0, c("no trt","MMF","MMF and others","others"),
       text.col=cl,pch=19,col= cl,horiz=TRUE, bty="n", cex = 1.2)

```


Outcome frequencies
```{r, echo=FALSE} 
load("pd.RData")
a = as.numeric(table(pd$type)) 
b = round(a/sum(a),2)
tab = data.frame(count = a, percent = b)
rownames(tab) = c("no trt", "MMF only","MMF and others", "others")
tab

acc = c( 0.6008968,  0.7056224,  0.5999719,  0.7006588 )
names = c("Train Mean", "Train Mode",  "Test Mean",  "Test Mode" )
round(acc,2)
```

70 percent test set accuracy based on posterior mode predictions.

Further considerations: 

 - include slope(s) of outcome trajectories as part of the covariates

 - mixed effect; shared frailty with the multivariate gaussian glmm

## seqHMM

Clustering over time: detect unobservable states, compress information across several types of observations.

## Soleimani et al. 2017

Why is this approach attractive?

 - In clinic, how far does a clinician wants to project into the future? If as far as one visit ahead (approx 6 months), then we might not need a medication model
 
 - Impulse response function captures how a blip in the treatment (or trt switching) causes an impulse to the outcome trajectory; ID 16 at time 9 and 17, ID 3229 at time 8.5
 
```{r, echo=FALSE}
load("dat.RData")
### Plot of (pFVC, -mRSS, EF) above and (Pred, MTX, MMF, CTX)
dat = dat[, c("Patient.ID","YTime","stppFVC","RVSP","Ejection.Fraction","Total.Skin.Score","type"), with=F]
colnames(dat)[5] = "EF"
colnames(dat)[6] = "nmRSS"
dat[,6] = -dat[,6]
dat = dat[order(Patient.ID, YTime),]

length(unique(dat$Patient.ID))#1211

# ind is 1 if FVC or mRSS does not have any measurement
dat[, ind := 1*(sum(!is.na(stppFVC[1:.N]))*sum(!is.na(nmRSS[1:.N]))*sum(!is.na(EF[1:.N])) ==0), by = Patient.ID]
dat = dat[ind==0,]
idlist = c(16,3229,916,1642)
#idlist = sample(unique(dat$Patient.ID),4)
layout(matrix(c(rep(1,3),2,rep(3,3),4,rep(5,3),6,rep(7,3),8), nrow = 8, ncol = 2))
  
for(id in idlist){
  pd = dat[Patient.ID == id,]
  ind1 = which(!is.na(pd$stppFVC)); timeFVC = pd$YTime[ind1]; FVC = pd$stppFVC[ind1]
ind2 = which(!is.na(pd$nmRSS)); timeRSS = pd$YTime[ind2]; RSS = pd$nmRSS[ind2]
ind3 = which(!is.na(pd$EF)); timeEF = pd$YTime[ind3]; EF = pd$EF[ind3]

rgt = range(c(timeFVC,timeRSS))

## add extra space to right margin of plot within frame
par(mar=c(0,4,3,4))

## Plot first set of data and draw its axis
plot(timeFVC, FVC, pch=16, axes=FALSE, ylim = range(FVC), xlab="", ylab="", xlim = rgt,
     type="b",col="black", main=paste0("ID ", id))
axis(2, ylim=range(FVC),col="black",las=1)  ## las=1 makes horizontal labels
mtext("FVC",side=2,line=2.5)
box()

## Allow a second plot on the same graph
par(new=TRUE)

## Plot the second plot and put axis scale on right
plot(timeRSS, RSS, pch=15,  xlab="", ylab="", ylim=range(RSS), xlim = rgt,
     axes=FALSE, type="b", col="red")
## a little farther out (line=4) to make room for labels
mtext("-mRSS",side=4,col="red",line=2.5) 
axis(4, ylim=range(RSS), col="red",col.axis="red",las=1)

## Allow a third plot on the same graph
par(new=TRUE)

## Plot the third plot and put axis scale on right
plot(timeEF, EF, pch=15,  xlab="", ylab="", ylim=range(EF), xlim = rgt,
     axes=FALSE, type="b", col="blue")

## Add Legend
#legend("topright",legend=c("pFVC","mRSS"),
#       text.col=c("black","red"),pch=c(16,15),col=c("black","red"),cex=1.5)

par(mar=c(4,4,0.5,4))
## Medication

ind = which(!is.na(pd$type)); t = pd$YTime[ind]; M = pd$type[ind]

plot(t, rep(0.5, length(t)), xlab="", ylab="",xlim = rgt, ylim = c(0,1),
       main="", col = M, pch = 19, axes=FALSE)

axis(1,pretty(rgt,10))
mtext("Time (Years since onset)",side=1,col="black",line=2.5)  
}
```

ID 1642

Input time of medication form versus actual time of medication initiation

